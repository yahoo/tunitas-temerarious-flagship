#!/bin/bash
cd ${0%/*} || exit 70

#
# WATCHOUT - this is a nonstandard test run
# WATCHOUT - this is a nonstandard test run, it applies --with-nonstd-half
# WATCHOUT - this is a nonstandard test run
#

set -xv
# PWD is expected to be .../tests/ac/SOMETHING
declare with_hypogeal_twilight=${PWD%/*/*/*}
# We're not testing buildconf, so use a "standard" one.   Any buildconf "that works" will do.
# Make it work.
if [[ ! -e ./buildconf ]] ; then
    if ! cp ../../../bc/template.autotools-style-buildconf buildconf ; then
        echo "${0}: error, could not copy a reasonable buildconf"
        exit 1
    fi 1>&2
fi
if [[ ! -x ./buildconf ]] ; then
    if ! chmod a+x ./buildconf ; then
        echo "${0}: error, could not make the buildconf executable"
        exit 1
    fi 1>&2
fi

function generate() {
    declare file=$1 ; shift
    declare tfile="$(dirname $file)/t99.$$.${RANDOM}.${file##*/}~"
    cat > ${tfile?} && chmod a-w ${tfile?} && mv ${tfile?} ${file?}
}
generate Makefile.am <<__Makefile__
# An minimal automake -*- Makefile -*-
# automatically generated by $0 at $(date --rfc-3339=seconds=seconds)
default:
__Makefile__

with_hypogeal_twilight=${with_hypogeal_twilight} ./buildconf

#
# We're testing this HGTW_CHECK_HALF
# Which means that a nonstd-half must be installed somewhere; e.g. nonstd-half-devel-1.12.0-2.0.fc29.gcc8.x86_64
# Here we "know" that it is installed in /opt/nonstd.
# This test will fail if such is not present
# [[FIXTHIS]] make a test for the positive and negative phases of the availability of nonstd-half-devel
#
./configure --with-nonstd-half=/opt/nonstd/half
